<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Despacho de Materiales</title>
  <!-- Tailwind CSS for basic styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Minimal custom styling for scrollbars */
    ::-webkit-scrollbar{height:8px;width:8px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-[1200px] mx-auto p-4">
    <header class="flex items-center justify-between gap-4 mb-4">
      <h1 class="text-2xl font-bold">üì¶ Despacho de Materiales</h1>
      <nav class="flex gap-2" id="tabs">
        <button data-tab="despacho" class="tab-btn px-4 py-2 rounded-lg bg-sky-600 text-white">Despacho</button>
        <button data-tab="descargas" class="tab-btn px-4 py-2 rounded-lg bg-white text-slate-700 border">Descargas</button>
      </nav>
    </header>

    <!-- DESPACHO -->
    <section id="view-despacho" class="space-y-4">
      <!-- Input fields -->
      <div class="grid md:grid-cols-5 grid-cols-1 gap-3">
        <div class="col-span-2">
          <label class="text-xs text-slate-500">N√∫mero de parte</label>
          <div class="flex gap-2">
            <input id="np" class="flex-1 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Escribe el n√∫mero de parte‚Ä¶" />
            <button id="btnBuscar" class="px-4 py-2 rounded-lg bg-sky-600 text-white">Buscar</button>
          </div>
        </div>
        <div>
          <label class="text-xs text-slate-500">Matr√≠cula (T5)</label>
          <input id="matricula" class="w-full px-3 py-2 rounded-lg border" />
        </div>
        <div>
          <label class="text-xs text-slate-500">N.E. T√©cnico (Q5)</label>
          <input id="neTecnico" class="w-full px-3 py-2 rounded-lg border" />
        </div>
        <div>
          <label class="text-xs text-slate-500">WO (W5)</label>
          <input id="wo" class="w-full px-3 py-2 rounded-lg border" />
        </div>
      </div>
      <div class="grid md:grid-cols-3 grid-cols-1 gap-3">
        <div>
          <label class="text-xs text-slate-500">Cliente</label>
          <select id="cliente" class="w-full px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-500">
            <option value="">‚Äî Selecciona cliente ‚Äî</option>
            <option>DELTA</option>
            <option>AMX</option>
            <option>ENDEAVOR</option>
            <option>JSX</option>
            <option>PSA</option>
            <option>SCY</option>
            <option>AVELO</option>
            <option>COPA</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-500">Usuario Almac√©n (N5)</label>
          <input id="usuarioAlmacen" class="w-full px-3 py-2 rounded-lg border" />
        </div>
        <div></div>
      </div>

      <!-- Table for despacho -->
      <div class="rounded-xl border bg-white overflow-hidden">
        <div class="px-4 py-3 border-b bg-slate-50 font-semibold">Material</div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm" id="tablaDespacho">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="px-2 py-2 text-left w-28">Alerta</th>
                <th class="px-2 py-2 text-left">Batch</th>
                <th class="px-2 py-2 text-left">Material</th>
                <th class="px-2 py-2 text-left">Material Description</th>
                <th class="px-2 py-2 text-left">BUn</th>
                <th class="px-2 py-2 text-left">MTyp</th>
                <th class="px-2 py-2 text-left">SLoc</th>
                <th class="px-2 py-2 text-left">Bin</th>
                <th class="px-2 py-2 text-right">Sum of Unrestricted</th>
                <th class="px-2 py-2 text-right">Cantidad</th>
                <th class="px-2 py-2 text-left">REMARK</th>
                <th class="px-2 py-2 text-left">COMENTARIOS</th>
                <th class="px-2 py-2 text-center">DESPACHO</th>
              </tr>
            </thead>
            <tbody id="bodyDespacho"></tbody>
          </table>
        </div>
      </div>
      <div class="flex items-center justify-between">
        <p class="text-xs text-slate-500">Tip: si una fila muestra <span class="font-semibold text-rose-600">SIN STOCK</span> no podr√° despacharse.</p>
        <div class="flex gap-2">
          <button id="btnBorrar" class="px-4 py-2 rounded-lg border">Borrar filas</button>
          <button id="btnDespachar" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">DESPACHAR MATERIAL</button>
        </div>
      </div>
    </section>

    <!-- DESCARGAS -->
    <section id="view-descargas" class="hidden">
      <div class="rounded-xl border bg-white overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b bg-slate-50">
          <div class="font-semibold">DESPACHOS REALIZADOS</div>
          <div class="flex items-center gap-2">
            <button id="btnLimpiarDescargas" class="px-3 py-1.5 rounded-lg border text-sm">Vaciar lista (local)</button>
            <button id="btnExportarDescargas" class="px-3 py-1.5 rounded-lg border text-sm">Exportar descargas</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm" id="tablaDescargas">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="px-2 py-2 text-left">MATR√çCULA</th>
                <th class="px-2 py-2 text-left">CLIENTE</th>
                <th class="px-2 py-2 text-left">NP</th>
                <th class="px-2 py-2 text-left">DESCRIPCI√ìN</th>
                <th class="px-2 py-2 text-left">W.O.</th>
                <th class="px-2 py-2 text-right">CANTIDAD</th>
                <th class="px-2 py-2 text-left">UM</th>
                <th class="px-2 py-2 text-left">SLOC</th>
                <th class="px-2 py-2 text-left">BATCH</th>
                <th class="px-2 py-2 text-left">N.E. T√âCNICO</th>
                <th class="px-2 py-2 text-left">USUARIO ALMAC√âN</th>
                <th class="px-2 py-2 text-left">FECHA</th>
                <th class="px-2 py-2 text-left">COMENTARIO</th>
              </tr>
            </thead>
            <tbody id="bodyDescargas"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
    <div class="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg">Tu despacho ha sido completado</div>
  </div>

  <!-- Script: main module -->
  <script type="module">
    // Import stock data from external file
    import STOCK_DATA from './stock-data.js';
    // We'll load optional config in init
    
    // ----- Global state -----
    let STOCK = STOCK_DATA || [];
    let DESCARGAS_LOCAL = [];
    let DESCARGAS_SHARED = [];
    let DESCARGAS = [];
    let CONFIG = null;
    let filasDespacho = [];
    let currentTab = 'despacho';

    // ----- Utility functions -----
    const $ = (s, ctx=document) => ctx.querySelector(s);
    const $all = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));
    const fmt = n => Number(n||0).toLocaleString('es-MX', { maximumFractionDigits: 2 });
    const toNum = v => {
      if (v == null) return 0;
      if (typeof v === 'number') return v;
      let s = String(v).trim();
      if (!s) return 0;
      const hasC = s.includes(',');
      const hasD = s.includes('.');
      if (hasC && hasD) {
        if (s.lastIndexOf('.') > s.lastIndexOf(',')) s = s.replace(/,/g, '');
        else s = s.replace(/\./g, '').replace(/,/g, '.');
      } else if (hasC) {
        s = s.replace(/,/g, '.');
      }
      s = s.replace(/[^0-9.-]/g, '');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    };
    function toast(msg) {
      const t = $('#toast');
      t.firstElementChild.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 1800);
    }

    // ----- Descargas: load/save/merge -----
    function loadLocalDescargas() {
      try {
        DESCARGAS_LOCAL = JSON.parse(localStorage.getItem('descargas_v1') || '[]');
      } catch {
        DESCARGAS_LOCAL = [];
      }
    }
    function saveLocalDescargas(arr) {
      localStorage.setItem('descargas_v1', JSON.stringify(arr || []));
      DESCARGAS_LOCAL = arr || [];
    }
    function recomputeDescargas() {
      DESCARGAS = (DESCARGAS_SHARED || []).concat(DESCARGAS_LOCAL || []);
    }

    async function pullDescargas() {
      // Fetch remote descargas.json using GitHub raw URL. Fallback to jsDelivr if needed.
      const gh = CONFIG?.github;
      let data = [];
      if (gh) {
          const urls = [
            `https://raw.githubusercontent.com/${gh.owner}/${gh.repo}/${gh.branch || 'main'}/descargas.json`,
            `https://cdn.jsdelivr.net/gh/${gh.owner}/${gh.repo}@${gh.branch || 'main'}/descargas.json`
          ];
          for (const url of urls) {
            try {
              const res = await fetch(url + '?t=' + Date.now(), { cache: 'no-store' });
              if (res.ok) {
                const json = await res.json();
                if (Array.isArray(json)) {
                  data = json;
                  break;
                }
              }
            } catch {}
          }
      }
      DESCARGAS_SHARED = data;
      loadLocalDescargas();
      recomputeDescargas();
    }

    async function pushDescargas() {
      // Push merged descargas to GitHub via API if token is provided
      const gh = CONFIG?.github;
      if (!gh || !gh.token) return false;
      try {
        const metaRes = await fetch(`https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/descargas.json?ref=${gh.branch || 'main'}`, {
          headers: {
            'Accept': 'application/vnd.github+json',
            'Authorization': `Bearer ${gh.token}`
          }
        });
        const meta = metaRes.ok ? await metaRes.json() : null;
        const sha = meta?.sha;
        // Merge shared (latest) and local
        const merged = (DESCARGAS_SHARED || []).concat(DESCARGAS_LOCAL || []);
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(merged, null, 2))));
        const body = {
          message: `chore(descargas): update ${new Date().toISOString()}`,
          content,
          branch: gh.branch || 'main',
          sha
        };
        const putRes = await fetch(`https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/descargas.json`, {
          method: 'PUT',
          headers: {
            'Accept': 'application/vnd.github+json',
            'Authorization': `Bearer ${gh.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        return putRes.ok;
      } catch (err) {
        console.warn('pushDescargas error', err);
        return false;
      }
    }

    function sumDespachado(material, sloc, batch) {
      return (DESCARGAS || []).filter(x => x.material === material && x.sloc === sloc && x.batch === batch).reduce((s, x) => s + Number(x.cantidad || 0), 0);
    }

    function stockPorNP(np) {
      const rows = (STOCK || []).filter(r => String(r.Material || '').toUpperCase() === String(np || '').toUpperCase());
      const map = new Map();
      for (const r of rows) {
        const key = `${r.Bin}|${r.SLoc}|${r.Batch}`;
        if (!map.has(key)) {
          map.set(key, { ...r });
        } else {
          map.get(key).Unrestricted = toNum(map.get(key).Unrestricted) + toNum(r.Unrestricted);
        }
      }
      return Array.from(map.values());
    }

    function buscar() {
      const np = $('#np').value.trim();
      if (!np) {
        filasDespacho = [];
        renderDespacho();
        return;
      }
      const items = stockPorNP(np);
      filasDespacho = items.map((r, idx) => {
        const ya = sumDespachado(r.Material, r.SLoc, r.Batch);
        const disponible = toNum(r.Unrestricted) - ya;
        return {
          id: idx + 1,
          alerta: disponible <= 0 ? 'SIN STOCK' : '',
          batch: r.Batch,
          material: r.Material,
          descripcion: r['Material Description'] ?? r.MaterialDescription ?? '',
          bun: r.BUn,
          mtyp: r.MTyp,
          sloc: r.SLoc,
          bin: r.Bin,
          stock: toNum(r.Unrestricted),
          disponible,
          qty: 0,
          remark: '',
          comentario: '',
          check: false,
          costo: toNum(r.COSTO || 0)
        };
      });
      renderDespacho();
    }

    function actualizarDisponibilidad() {
      // Update available values and row classes based on current DESCARGAS
      for (const row of filasDespacho) {
        const ya = sumDespachado(row.material, row.sloc, row.batch);
        const disp = toNum(row.stock) - ya;
        row.disponible = disp;
        row.alerta = disp <= 0 ? 'SIN STOCK' : '';
      }
    }

    function renderDespacho() {
      const tb = $('#bodyDespacho');
      tb.innerHTML = '';
      for (const f of filasDespacho) {
        const danger = f.alerta === 'SIN STOCK' || (f.qty > 0 && f.qty > f.disponible);
        const alerta = danger ? 'SIN STOCK' : '';
        tb.insertAdjacentHTML('beforeend', `
          <tr class="border-b ${danger ? 'bg-rose-50' : ''} hover:bg-sky-50 transition-colors">
            <td class="px-2 py-1 text-rose-600 font-semibold">${alerta}</td>
            <td class="px-2 py-1">${f.batch || ''}</td>
            <td class="px-2 py-1">${f.material}</td>
            <td class="px-2 py-1">${f.descripcion || ''}</td>
            <td class="px-2 py-1">${f.bun || ''}</td>
            <td class="px-2 py-1">${f.mtyp || ''}</td>
            <td class="px-2 py-1">${f.sloc || ''}</td>
            <td class="px-2 py-1">${f.bin || ''}</td>
            <td class="px-2 py-1 text-right">${fmt(f.stock)} <span class="text-xs text-slate-500">(disp: ${fmt(f.disponible)})</span></td>
            <td class="px-2 py-1 text-right">
              <input type="number" min="0" step="1" value="${f.qty}" data-id="${f.id}" class="qty w-20 px-2 py-1 rounded-md border text-right" />
            </td>
            <td class="px-2 py-1">${f.remark || ''}</td>
            <td class="px-2 py-1">
              <input data-id="${f.id}" class="coment w-56 px-2 py-1 rounded-md border" placeholder="Comentario" value="${f.comentario || ''}" />
            </td>
            <td class="px-2 py-1 text-center">
              <input type="checkbox" data-id="${f.id}" class="chk w-5 h-5" ${f.check ? 'checked' : ''} ${danger ? 'disabled' : ''} />
            </td>
          </tr>
        `);
      }
      // Attach events on each input without re-rendering entire table on each keypress
      const tbody = $('#bodyDespacho');
      tbody.querySelectorAll('.qty').forEach(inp => {
        const id = Number(inp.dataset.id);
        const row = filasDespacho.find(x => x.id === id);
        inp.addEventListener('input', e => {
          row.qty = Math.floor(toNum(e.target.value || 0));
        });
        // On blur or change, recompute row class and available highlight
        inp.addEventListener('change', () => {
          actualizarDisponibilidad();
          renderDespacho();
        });
      });
      tbody.querySelectorAll('.coment').forEach(inp => {
        const id = Number(inp.dataset.id);
        const row = filasDespacho.find(x => x.id === id);
        inp.addEventListener('input', e => {
          row.comentario = e.target.value;
        });
      });
      tbody.querySelectorAll('.chk').forEach(inp => {
        const id = Number(inp.dataset.id);
        const row = filasDespacho.find(x => x.id === id);
        inp.addEventListener('change', e => {
          row.check = e.target.checked;
        });
      });
    }

    async function despachar() {
      const matricula = $('#matricula').value.trim();
      const neTecnico = $('#neTecnico').value.trim();
      const usuarioAlmacen = $('#usuarioAlmacen').value.trim();
      const wo = $('#wo').value.trim();
      const cliente = $('#cliente').value;
      const nuevos = [];
      for (const f of filasDespacho) {
        const danger = (f.disponible <= 0) || (f.qty > 0 && f.qty > f.disponible);
        if (!f.check || !f.qty || danger) continue;
        nuevos.push({
          matricula,
          cliente,
          np: f.material,
          descripcion: f.descripcion,
          wo,
          cantidad: Math.floor(f.qty),
          um: f.bun,
          sloc: f.sloc,
          batch: f.batch,
          neTecnico,
          usuarioAlmacen,
          fecha: new Date().toISOString().replace('T', ' ').slice(0, 16),
          comentario: f.comentario,
          material: f.material
        });
      }
      if (nuevos.length === 0) return;
      // Add to local
      loadLocalDescargas();
      const mergedLocal = (DESCARGAS_LOCAL || []).concat(nuevos);
      saveLocalDescargas(mergedLocal);
      recomputeDescargas();
      // Attempt push to repo
      const pushed = await pushDescargas();
      if (pushed) {
        await pullDescargas();
      }
      // Clear selected rows
      filasDespacho = filasDespacho.filter(f => !(f.check && f.qty));
      actualizarDisponibilidad();
      renderDespacho();
      if (currentTab === 'descargas') renderDescargas();
      toast(pushed ? 'Sincronizado en repositorio' : 'Despacho guardado localmente');
    }

    function renderDescargas() {
      const tb = $('#bodyDescargas');
      tb.innerHTML = '';
      for (const r of (DESCARGAS || [])) {
        tb.insertAdjacentHTML('beforeend', `
          <tr class="border-b hover:bg-sky-50 transition-colors">
            <td class="px-2 py-1">${r.matricula || ''}</td>
            <td class="px-2 py-1">${r.cliente || ''}</td>
            <td class="px-2 py-1">${r.np || ''}</td>
            <td class="px-2 py-1">${r.descripcion || ''}</td>
            <td class="px-2 py-1">${r.wo || ''}</td>
            <td class="px-2 py-1 text-right">${r.cantidad ?? 0}</td>
            <td class="px-2 py-1">${r.um || ''}</td>
            <td class="px-2 py-1">${r.sloc || ''}</td>
            <td class="px-2 py-1">${r.batch || ''}</td>
            <td class="px-2 py-1">${r.neTecnico || ''}</td>
            <td class="px-2 py-1">${r.usuarioAlmacen || ''}</td>
            <td class="px-2 py-1">${r.fecha || ''}</td>
            <td class="px-2 py-1">${r.comentario || ''}</td>
          </tr>
        `);
      }
    }

    // Export descargas as Excel
    async function exportDescargas() {
      // Use SheetJS to convert JSON to worksheet and save as xlsx
      const rows = (DESCARGAS || []).map(r => ({
        'Matr√≠cula': r.matricula || '',
        'Cliente': r.cliente || '',
        'NP': r.np || '',
        'Descripci√≥n': r.descripcion || '',
        'W.O.': r.wo || '',
        'Cantidad': r.cantidad ?? 0,
        'UM': r.um || '',
        'SLOC': r.sloc || '',
        'Batch': r.batch || '',
        'N.E. T√©cnico': r.neTecnico || '',
        'Usuario Almac√©n': r.usuarioAlmacen || '',
        'Fecha': r.fecha || '',
        'Comentario': r.comentario || ''
      }));
      const { utils, writeFile, book_new, book_append_sheet, json_to_sheet } = await import('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js');
      const ws = json_to_sheet(rows);
      const wb = book_new();
      book_append_sheet(wb, ws, 'Descargas');
      writeFile(wb, 'descargas.xlsx');
    }

    // ----- Tab switching -----
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('#tabs .tab-btn').forEach(btn => {
        btn.classList.remove('bg-sky-600', 'text-white');
        btn.classList.add('bg-white', 'text-slate-700', 'border');
      });
      document.querySelector(`[data-tab="${tab}"]`).classList.add('bg-sky-600', 'text-white');
      document.querySelector(`[data-tab="${tab}"]`).classList.remove('bg-white', 'text-slate-700', 'border');
      document.querySelectorAll('section[id^="view-"]').forEach(sec => sec.classList.add('hidden'));
      document.getElementById('view-' + tab).classList.remove('hidden');
      if (tab === 'descargas') {
        renderDescargas();
      }
    }

    // ----- Initialization -----
    async function init() {
      // Load config (if exists)
      try {
        const mod = await import('./config.js');
        CONFIG = mod.default || null;
      } catch {
        CONFIG = null;
      }
      // Load local descargas and remote
      loadLocalDescargas();
      await pullDescargas();
      // Bind events
      $('#btnBuscar').addEventListener('click', buscar);
      $('#np').addEventListener('keydown', e => { if (e.key === 'Enter') buscar(); });
      $('#btnDespachar').addEventListener('click', despachar);
      $('#btnBorrar').addEventListener('click', () => {
        filasDespacho = [];
        $('#np').value = '';
        renderDespacho();
      });
      $('#btnLimpiarDescargas').addEventListener('click', () => {
        if (confirm('¬øVaciar la lista local de descargas?')) {
          localStorage.removeItem('descargas_v1');
          DESCARGAS_LOCAL = [];
          recomputeDescargas();
          if (currentTab === 'descargas') renderDescargas();
        }
      });
      $('#btnExportarDescargas').addEventListener('click', exportDescargas);
      // Tabs
      document.querySelectorAll('#tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });
      // Auto refresh every 2s: update remote data and availability
      setInterval(async () => {
        await pullDescargas();
        if (filasDespacho.length > 0) {
          actualizarDisponibilidad();
          renderDespacho();
        }
        if (currentTab === 'descargas') renderDescargas();
      }, 2000);
    }
    // Start the app
    init();
  </script>
</body>
</html>
