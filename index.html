<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Despacho de Materiales</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ::-webkit-scrollbar{height:8px;width:8px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-[1200px] mx-auto p-4">
    <header class="flex items-center justify-between gap-4 mb-4">
      <h1 class="text-2xl font-bold">üì¶ Despacho de Materiales</h1>
      <nav class="flex gap-2" id="tabs">
        <button data-tab="despacho" class="tab-btn px-4 py-2 rounded-lg bg-sky-600 text-white">Despacho</button>
        <button data-tab="stock" class="tab-btn px-4 py-2 rounded-lg bg-white text-slate-700 border">Stock</button>
        <button data-tab="descargas" class="tab-btn px-4 py-2 rounded-lg bg-white text-slate-700 border">Descargas</button>
      </nav>
    </header>

    <!-- Secci√≥n Despacho -->
    <section id="view-despacho" class="space-y-4">
      <div class="grid md:grid-cols-5 grid-cols-1 gap-3">
        <div class="col-span-2">
          <label class="text-xs text-slate-500">N√∫mero de parte</label>
          <div class="flex gap-2">
            <input id="np" class="flex-1 px-3 py-2 rounded-lg border focus:ring-2 focus:ring-sky-500" placeholder="Escribe el n√∫mero de parte‚Ä¶" />
            <button id="btnBuscar" class="px-4 py-2 rounded-lg bg-sky-600 text-white">Buscar</button>
          </div>
        </div>
        <div><label class="text-xs text-slate-500">Matr√≠cula</label><input id="matricula" class="w-full px-3 py-2 rounded-lg border" /></div>
        <div><label class="text-xs text-slate-500">N.E. T√©cnico</label><input id="neTecnico" class="w-full px-3 py-2 rounded-lg border" /></div>
        <div><label class="text-xs text-slate-500">W.O.</label><input id="wo" class="w-full px-3 py-2 rounded-lg border" /></div>
      </div>

      <div class="rounded-xl border bg-white overflow-hidden">
        <div class="px-4 py-3 border-b bg-slate-50 font-semibold">Material</div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm" id="tablaDespacho">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th>Alerta</th><th>Batch</th><th>Material</th><th>Descripci√≥n</th>
                <th>BUn</th><th>MTyp</th><th>SLoc</th><th>Bin</th>
                <th>Stock</th><th>Cant. Despachada</th>
                <th>Remark</th><th>Comentarios</th><th>Despacho</th>
              </tr>
            </thead>
            <tbody id="bodyDespacho"></tbody>
          </table>
        </div>
      </div>

      <div class="flex justify-between items-center">
        <p class="text-xs text-slate-500">Si aparece <span class="text-rose-600 font-semibold">SIN STOCK</span>, no se puede despachar.</p>
        <div class="flex gap-2">
          <button id="btnBorrar" class="px-4 py-2 border rounded-lg">Borrar filas</button>
          <button id="btnDespachar" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">DESPACHAR</button>
        </div>
      </div>
    </section>

    <!-- Secci√≥n Stock -->
    <section id="view-stock" class="hidden">
      <div class="rounded-xl border bg-white overflow-hidden">
        <div class="flex justify-between px-4 py-3 border-b bg-slate-50">
          <div class="font-semibold">STOCK</div>
          <div class="flex gap-2">
            <input id="fileExcel" type="file" accept=".xlsx,.xls" class="hidden" />
            <button id="btnCargarExcel" class="px-3 py-1.5 border rounded-lg text-sm">Cargar Excel</button>
            <button id="btnExportarStock" class="px-3 py-1.5 border rounded-lg text-sm">Exportar</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm" id="tablaStock">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th>Material</th><th>Descripci√≥n</th><th>SLoc</th><th>Bin</th>
                <th>Unrestricted</th><th>BUn</th><th>Batch</th><th>MTyp</th><th>COSTO</th>
              </tr>
            </thead>
            <tbody id="bodyStock"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Secci√≥n Descargas -->
    <section id="view-descargas" class="hidden">
      <div class="rounded-xl border bg-white overflow-hidden">
        <div class="flex justify-between px-4 py-3 border-b bg-slate-50">
          <div class="font-semibold">DESPACHOS REALIZADOS</div>
          <button id="btnLimpiarDescargas" class="px-3 py-1.5 border rounded-lg text-sm">Vaciar lista</button>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm" id="tablaDescargas">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th>Matr√≠cula</th><th>NP</th><th>Descripci√≥n</th><th>W.O.</th>
                <th>Cantidad</th><th>UM</th><th>SLoc</th><th>Batch</th>
                <th>N.E. T√©cnico</th><th>Usuario</th><th>Fecha</th><th>Comentario</th>
              </tr>
            </thead>
            <tbody id="bodyDescargas"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
    <div class="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg">Tu despacho ha sido completado</div>
  </div>

  <!-- Script principal -->
  <script type="module">
    import STOCK_DATA from './stock-data.js';
    let STOCK = STOCK_DATA || [];
    let DESCARGAS = JSON.parse(localStorage.getItem('descargas_v1') || '[]');

    function formatNumber(n){return Number(n||0).toLocaleString('es-MX',{maximumFractionDigits:2});}
    function saveDescargas(){localStorage.setItem('descargas_v1', JSON.stringify(DESCARGAS));}

    function renderStock(){
      const tb=document.getElementById('bodyStock');tb.innerHTML='';
      for(const r of STOCK){
        tb.insertAdjacentHTML('beforeend',`<tr class="border-b"><td>${r.Material}</td><td>${r["Material Description"]||r.MaterialDescription}</td><td>${r.SLoc}</td><td>${r.Bin}</td><td>${formatNumber(r.Unrestricted)}</td><td>${r.BUn}</td><td>${r.Batch}</td><td>${r.MTyp}</td><td>${formatNumber(r.COSTO)}</td></tr>`);
      }
    }

    function renderDescargas(){
      const tb=document.getElementById('bodyDescargas');tb.innerHTML='';
      for(const d of DESCARGAS){
        tb.insertAdjacentHTML('beforeend',`<tr class="border-b"><td>${d.matricula}</td><td>${d.np}</td><td>${d.descripcion}</td><td>${d.wo}</td><td>${formatNumber(d.cantidad)}</td><td>${d.um}</td><td>${d.sloc}</td><td>${d.batch}</td><td>${d.neTecnico}</td><td>${d.usuarioAlmacen}</td><td>${d.fecha}</td><td>${d.comentario}</td></tr>`);
      }
    }

    document.getElementById('btnBuscar').addEventListener('click',()=>{
      const np=document.getElementById('np').value.trim().toUpperCase();
      const items=STOCK.filter(x=>String(x.Material).toUpperCase()===np);
      const tb=document.getElementById('bodyDespacho');tb.innerHTML='';
      for(const r of items){
        tb.insertAdjacentHTML('beforeend',`
          <tr class="border-b">
            <td>${r.Unrestricted<=0?'SIN STOCK':''}</td><td>${r.Batch}</td><td>${r.Material}</td>
            <td>${r["Material Description"]||r.MaterialDescription}</td><td>${r.BUn}</td><td>${r.MTyp}</td>
            <td>${r.SLoc}</td><td>${r.Bin}</td>
            <td class="text-right">${formatNumber(r.Unrestricted)}</td>
            <td><input type="number" min="0" class="qty w-20 border rounded px-1 py-0.5" /></td>
            <td></td><td><input class="coment w-40 border rounded px-1 py-0.5" placeholder="Comentario" /></td>
            <td><input type="checkbox" class="chk w-5 h-5" /></td>
          </tr>`);
      }
    });

    document.getElementById('btnDespachar').addEventListener('click',()=>{
      const rows=document.querySelectorAll('#bodyDespacho tr');
      const matricula=document.getElementById('matricula').value.trim();
      const neTecnico=document.getElementById('neTecnico').value.trim();
      const wo=document.getElementById('wo').value.trim();
      for(const r of rows){
        const chk=r.querySelector('.chk');
        const qty=Number(r.querySelector('.qty').value||0);
        if(chk.checked && qty>0){
          DESCARGAS.push({
            matricula, np:r.children[2].textContent, descripcion:r.children[3].textContent,
            wo, cantidad:qty, um:r.children[4].textContent, sloc:r.children[6].textContent,
            batch:r.children[1].textContent, neTecnico, usuarioAlmacen:'', fecha:new Date().toLocaleString(),
            comentario:r.querySelector('.coment').value
          });
        }
      }
      saveDescargas();
      document.getElementById('toast').classList.remove('hidden');
      setTimeout(()=>document.getElementById('toast').classList.add('hidden'),2000);
      document.getElementById('bodyDespacho').innerHTML='';
    });

    document.getElementById('btnBorrar').addEventListener('click',()=>document.getElementById('bodyDespacho').innerHTML='');
    document.getElementById('btnLimpiarDescargas').addEventListener('click',()=>{
      if(confirm('¬øVaciar lista de descargas?')){DESCARGAS=[];saveDescargas();renderDescargas();}
    });

    document.querySelectorAll('#tabs .tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const tab=btn.dataset.tab;
        document.querySelectorAll('#tabs .tab-btn').forEach(b=>b.classList.remove('bg-sky-600','text-white'));
        btn.classList.add('bg-sky-600','text-white');
        document.querySelectorAll('section[id^=\"view-\"]').forEach(s=>s.classList.add('hidden'));
        document.getElementById('view-'+tab).classList.remove('hidden');
        if(tab==='stock')renderStock();
        if(tab==='descargas')renderDescargas();
      });
    });
  </script>
</body>
</html>

