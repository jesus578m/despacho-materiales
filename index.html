<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Despacho de Materiales</title>

  <!-- Tailwind CSS para estilos b√°sicos -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Scrollbar sutil */
    ::-webkit-scrollbar{height:8px;width:8px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
  </style>

  <!-- Librer√≠a SheetJS para exportar descargas -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-[1200px] mx-auto p-4">
    <!-- Encabezado y navegaci√≥n -->
    <header class="flex items-center justify-between gap-4 mb-4">
      <h1 class="text-2xl font-bold">üì¶ Despacho de Materiales</h1>
      <nav class="flex gap-2" id="tabs">
        <button data-tab="despacho" class="tab-btn px-4 py-2 rounded-lg bg-sky-600 text-white">Despacho</button>
        <button data-tab="descargas" class="tab-btn px-4 py-2 rounded-lg bg-white text-slate-700 border">Descargas</button>
      </nav>
    </header>

    <!-- Secci√≥n de despacho -->
    <section id="view-despacho" class="space-y-4">
      <div class="grid md:grid-cols-5 grid-cols-1 gap-3">
        <div class="col-span-2">
          <label class="text-xs text-slate-500">N√∫mero de parte</label>
          <div class="flex gap-2">
            <input id="np" class="flex-1 px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Escribe el n√∫mero de parte‚Ä¶" />
            <button id="btnBuscar" class="px-4 py-2 rounded-lg bg-sky-600 text-white">Buscar</button>
          </div>
        </div>
        <div>
          <label class="text-xs text-slate-500">Matr√≠cula (T5)</label>
          <input id="matricula" class="w-full px-3 py-2 rounded-lg border" />
        </div>
        <div>
          <label class="text-xs text-slate-500">N.E. T√©cnico (Q5)</label>
          <input id="neTecnico" class="w-full px-3 py-2 rounded-lg border" />
        </div>
        <div>
          <label class="text-xs text-slate-500">WO (W5)</label>
          <input id="wo" class="w-full px-3 py-2 rounded-lg border" />
        </div>
      </div>
      <div class="grid md:grid-cols-3 grid-cols-1 gap-3">
        <div>
          <label class="text-xs text-slate-500">Cliente</label>
          <select id="cliente" class="w-full px-3 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-sky-500">
            <option value="">‚Äî Selecciona cliente ‚Äî</option>
            <option>DELTA</option>
            <option>AMX</option>
            <option>ENDEAVOR</option>
            <option>JSX</option>
            <option>PSA</option>
            <option>SCY</option>
            <option>AVELO</option>
            <option>COPA</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-500">Usuario Almac√©n (N5)</label>
          <input id="usuarioAlmacen" class="w-full px-3 py-2 rounded-lg border" />
        </div>
        <div class="hidden"></div>
      </div>

      <div class="rounded-xl border bg-white overflow-hidden">
        <div class="px-4 py-3 border-b bg-slate-50 font-semibold">Material</div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm" id="tablaDespacho">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="px-2 py-2 text-left w-28">Alerta</th>
                <th class="px-2 py-2 text-left">Batch</th>
                <th class="px-2 py-2 text-left">Material</th>
                <th class="px-2 py-2 text-left">Material Description</th>
                <th class="px-2 py-2 text-left">BUn</th>
                <th class="px-2 py-2 text-left">MTyp</th>
                <th class="px-2 py-2 text-left">SLoc</th>
                <th class="px-2 py-2 text-left">Bin</th>
                <th class="px-2 py-2 text-right">Sum of Unrestricted</th>
                <th class="px-2 py-2 text-right">Cantidad</th>
                <th class="px-2 py-2 text-left">REMARK</th>
                <th class="px-2 py-2 text-left">COMENTARIOS</th>
                <th class="px-2 py-2 text-center">DESPACHO</th>
              </tr>
            </thead>
            <tbody id="bodyDespacho"></tbody>
          </table>
        </div>
      </div>
      <div class="flex items-center justify-between">
        <p class="text-xs text-slate-500">Si aparece <span class="font-semibold text-rose-600">SIN STOCK</span>, no se podr√° despachar.</p>
        <div class="flex gap-2">
          <button id="btnBorrar" class="px-4 py-2 rounded-lg border">Borrar filas</button>
          <button id="btnDespachar" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">DESPACHAR MATERIAL</button>
        </div>
      </div>
    </section>

    <!-- Secci√≥n de descargas -->
    <section id="view-descargas" class="hidden">
      <div class="rounded-xl border bg-white overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b bg-slate-50">
          <div class="font-semibold">DESPACHOS REALIZADOS</div>
          <div class="flex items-center gap-2">
            <button id="btnLimpiarDescargas" class="px-3 py-1.5 rounded-lg border text-sm">Vaciar lista (local)</button>
            <button id="btnExportarDescargas" class="px-3 py-1.5 rounded-lg border text-sm">Exportar descargas</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm" id="tablaDescargas">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="px-2 py-2 text-left">MATR√çCULA</th>
                <th class="px-2 py-2 text-left">CLIENTE</th>
                <th class="px-2 py-2 text-left">NP</th>
                <th class="px-2 py-2 text-left">DESCRIPCI√ìN</th>
                <th class="px-2 py-2 text-left">W.O.</th>
                <th class="px-2 py-2 text-right">CANTIDAD</th>
                <th class="px-2 py-2 text-left">UM</th>
                <th class="px-2 py-2 text-left">SLOC</th>
                <th class="px-2 py-2 text-left">BATCH</th>
                <th class="px-2 py-2 text-left">N.E. T√âCNICO</th>
                <th class="px-2 py-2 text-left">USUARIO ALMAC√âN</th>
                <th class="px-2 py-2 text-left">FECHA</th>
                <th class="px-2 py-2 text-left">COMENTARIO</th>
              </tr>
            </thead>
            <tbody id="bodyDescargas"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast para notificaciones -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
    <div class="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg">Tu despacho ha sido completado</div>
  </div>

  <!-- La configuraci√≥n (config.js) se cargar√° de manera diferida en el inicializador -->

  <!-- L√≥gica de la aplicaci√≥n -->
  <script type="module">
    import STOCK_DATA from './stock-data.js';
    // Define configuraci√≥n global para que exista antes de cargarla en init()
    if (typeof window.__CONFIG__ === 'undefined') {
      window.__CONFIG__ = null;
    }

    // ===== Variables de estado =====
    let STOCK = STOCK_DATA || [];
    let filasDespacho = [];
    // Descargas: base local y remota
    const LS_DESC = 'descargas_v1';
    let DESCARGAS_SHARED = [];
    let DESCARGAS_LOCAL  = [];
    let DESCARGAS        = [];

    // ===== Utilidades =====
    const $    = (sel, ctx=document) => ctx.querySelector(sel);
    const $all = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const fmt  = n => Number(n||0).toLocaleString('es-MX',{maximumFractionDigits:2});
    const toNum = v => {
      if(v==null) return 0;
      if(typeof v==='number') return v;
      let s = String(v).trim();
      if(!s) return 0;
      const hasC = s.includes(',');
      const hasD = s.includes('.');
      if(hasC && hasD){
        if(s.lastIndexOf('.') > s.lastIndexOf(',')) s = s.replace(/,/g,'');
        else s = s.replace(/\./g,'').replace(/,/g,'.');
      } else if(hasC){ s = s.replace(/,/g,'.'); }
      s = s.replace(/[^0-9.-]/g,'');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    };

    function toast(msg='Tu despacho ha sido completado'){
      const t = $('#toast');
      t.firstElementChild.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 1800);
    }

    // ===== Descargas: funciones de sincronizaci√≥n =====
    function loadLocalDescargas(){
      try { DESCARGAS_LOCAL = JSON.parse(localStorage.getItem(LS_DESC) || '[]'); }
      catch { DESCARGAS_LOCAL = []; }
    }
    function saveLocalDescargas(arr){
      localStorage.setItem(LS_DESC, JSON.stringify(arr||[]));
      DESCARGAS_LOCAL = arr || [];
    }
    function recomputeDescargas(){
      DESCARGAS = (DESCARGAS_SHARED || []).concat(DESCARGAS_LOCAL || []);
    }
    async function pullDescargas(){
      try {
        const GH = window.__CONFIG__?.github;
        if(GH){
          const rawUrl = `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch || 'main'}/descargas.json?t=${Date.now()}`;
          let ok = false;
          try{
            const res = await fetch(rawUrl, {cache:'no-store'});
            if(res.ok){
              DESCARGAS_SHARED = await res.json();
              ok = true;
            }
          }catch(_){/* ignore */}
          if(!ok){
            // Fallback a jsDelivr (CDN) si falla raw.githubusercontent
            const cdnUrl = `https://cdn.jsdelivr.net/gh/${GH.owner}/${GH.repo}@${GH.branch || 'main'}/descargas.json`;
            try{
              const res2 = await fetch(cdnUrl, {cache:'no-store'});
              DESCARGAS_SHARED = res2.ok ? await res2.json() : [];
            }catch(_){ DESCARGAS_SHARED = []; }
          }
        } else {
          DESCARGAS_SHARED = [];
        }
      } catch(e){ DESCARGAS_SHARED = []; }
      loadLocalDescargas();
      recomputeDescargas();
    }
    async function pushDescargas(){
      const GH = window.__CONFIG__?.github;
      if(!GH?.token) return false;
      try {
        // Obtiene SHA actual de descargas.json
        const metaRes = await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/descargas.json?ref=${GH.branch || 'main'}`, {
          headers: { 'Accept':'application/vnd.github+json', 'Authorization':`Bearer ${GH.token}` }
        });
        const meta = metaRes.ok ? await metaRes.json() : null;
        const sha  = meta?.sha;
        // Construye contenido: remote (shared) + local
        const contentArr = (DESCARGAS_SHARED || []).concat(DESCARGAS_LOCAL || []);
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(contentArr, null, 2))));
        const body = {
          message: `chore(descargas): update ${new Date().toISOString()}`,
          content,
          branch: GH.branch || 'main',
          sha
        };
        const putRes = await fetch(`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/descargas.json`, {
          method:'PUT',
          headers:{ 'Accept':'application/vnd.github+json', 'Authorization':`Bearer ${GH.token}`, 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        return putRes.ok;
      } catch(e){ console.warn('push error', e); return false; }
    }

    // ===== Stock y b√∫squeda =====
    function sumDespachado(material, sloc, batch){
      return (DESCARGAS || []).filter(x => x.material === material && x.sloc === sloc && x.batch === batch).reduce((s,x) => s + Number(x.cantidad || 0), 0);
    }
    function stockPorNP(np){
      const rows = (STOCK || []).filter(x => String(x.Material || '').toUpperCase() === String(np || '').toUpperCase());
      const map = new Map();
      for(const r of rows){
        const key = `${r.Bin}|${r.SLoc}|${r.Batch}`;
        const total = toNum(r.Unrestricted);
        if(!map.has(key)) map.set(key, {...r, Unrestricted: total});
        else map.get(key).Unrestricted += total;
      }
      return Array.from(map.values());
    }

    // Actualiza la disponibilidad y alerta en las filas de despacho sin reiniciar otras propiedades
    function actualizarDisponibilidad(){
      // Recalcula la cantidad ya despachada y la disponibilidad para cada fila actual
      for(const row of filasDespacho){
        const ya = sumDespachado(row.material, row.sloc, row.batch);
        row.disponible = toNum(row.stock) - ya;
        row.alerta = row.disponible <= 0 ? 'SIN STOCK' : '';
      }
    }

    // ===== Render de despacho =====
    function renderDespacho(){
      const tb = document.getElementById('bodyDespacho');
      tb.innerHTML = '';
      for(const f of filasDespacho){
        const danger = f.alerta === 'SIN STOCK' || (f.qty > 0 && f.qty > f.disponible);
        const alerta = danger ? 'SIN STOCK' : '';
        tb.insertAdjacentHTML('beforeend', `
          <tr class="border-b ${danger ? 'bg-rose-50' : ''} hover:bg-sky-50 transition-colors">
            <td class="px-2 py-1 text-rose-600 font-semibold">${alerta}</td>
            <td class="px-2 py-1">${f.batch || ''}</td>
            <td class="px-2 py-1">${f.material}</td>
            <td class="px-2 py-1">${f.descripcion || ''}</td>
            <td class="px-2 py-1">${f.bun || ''}</td>
            <td class="px-2 py-1">${f.mtyp || ''}</td>
            <td class="px-2 py-1">${f.sloc || ''}</td>
            <td class="px-2 py-1">${f.bin || ''}</td>
            <td class="px-2 py-1 text-right">${fmt(f.stock)} <span class="text-xs text-slate-500">(disp: ${fmt(f.disponible)})</span></td>
            <td class="px-2 py-1 text-right">
              <input type="number" min="0" step="1" value="${f.qty}" data-id="${f.id}" class="qty w-24 px-2 py-1 rounded-md border text-right" />
            </td>
            <td class="px-2 py-1"></td>
            <td class="px-2 py-1"><input data-id="${f.id}" class="coment w-56 px-2 py-1 rounded-md border" placeholder="Comentario" value="${f.comentario || ''}"/></td>
            <td class="px-2 py-1 text-center"><input type="checkbox" ${f.check ? 'checked' : ''} data-id="${f.id}" class="chk w-5 h-5" ${danger ? 'disabled' : ''} /></td>
          </tr>
        `);
      }
      // Asignar listeners a las nuevas celdas
      const tbody = document.getElementById('bodyDespacho');
      tbody.querySelectorAll('.qty').forEach(inp => {
        // Actualiza cantidad a cada cambio de entrada, sin re-renderizar
        inp.addEventListener('input', e => {
          const id = Number(e.target.dataset.id);
          const row = filasDespacho.find(x => x.id === id);
          row.qty = Math.floor(toNum(e.target.value || 0));
        });
        // Al finalizar la edici√≥n (change), recalcula alertas y re-renderiza
        inp.addEventListener('change', e => {
          const id = Number(e.target.dataset.id);
          const row = filasDespacho.find(x => x.id === id);
          row.qty = Math.floor(toNum(e.target.value || 0));
          renderDespacho();
        });
      });
      tbody.querySelectorAll('.coment').forEach(inp => {
        inp.addEventListener('input', e => {
          const id = Number(e.target.dataset.id);
          const row = filasDespacho.find(x => x.id === id);
          row.comentario = e.target.value;
        });
      });
      tbody.querySelectorAll('.chk').forEach(inp => {
        inp.addEventListener('change', e => {
          const id = Number(e.target.dataset.id);
          const row = filasDespacho.find(x => x.id === id);
          row.check = e.target.checked;
        });
      });
    }

    // ===== Render de descargas =====
    function renderDescargas(){
      const tb = document.getElementById('bodyDescargas');
      tb.innerHTML = '';
      for(const r of (DESCARGAS || [])){
        tb.insertAdjacentHTML('beforeend', `
          <tr class="border-b hover:bg-sky-50 transition-colors">
            <td class="px-2 py-1">${r.matricula || ''}</td>
            <td class="px-2 py-1">${r.cliente || ''}</td>
            <td class="px-2 py-1">${r.np || ''}</td>
            <td class="px-2 py-1">${r.descripcion || ''}</td>
            <td class="px-2 py-1">${r.wo || ''}</td>
            <td class="px-2 py-1 text-right">${r.cantidad ?? 0}</td>
            <td class="px-2 py-1">${r.um || ''}</td>
            <td class="px-2 py-1">${r.sloc || ''}</td>
            <td class="px-2 py-1">${r.batch || ''}</td>
            <td class="px-2 py-1">${r.neTecnico || ''}</td>
            <td class="px-2 py-1">${r.usuarioAlmacen || ''}</td>
            <td class="px-2 py-1">${r.fecha || ''}</td>
            <td class="px-2 py-1">${r.comentario || ''}</td>
          </tr>
        `);
      }
    }

    // ===== Buscar NP y cargar filas de despacho =====
    function buscar(){
      const np = document.getElementById('np').value.trim();
      if(!np){ filasDespacho = []; document.getElementById('bodyDespacho').innerHTML = ''; return; }
      const items = stockPorNP(np);
      filasDespacho = items.map((r, idx) => {
        const ya = sumDespachado(r.Material, r.SLoc, r.Batch);
        const disponible = toNum(r.Unrestricted) - ya;
        return {
          id: idx + 1,
          alerta: disponible <= 0 ? 'SIN STOCK' : '',
          batch: r.Batch,
          material: r.Material,
          descripcion: r['Material Description'] ?? r.MaterialDescription ?? '',
          bun: r.BUn,
          mtyp: r.MTyp,
          sloc: r.SLoc,
          bin: r.Bin,
          stock: toNum(r.Unrestricted),
          disponible,
          qty: 0,
          remark: '',
          comentario: '',
          check: false,
          costo: toNum(r.COSTO || 0)
        };
      });
      renderDespacho();
    }

    // ===== Despachar =====
    async function despachar(){
      const matricula      = document.getElementById('matricula').value.trim();
      const neTecnico      = document.getElementById('neTecnico').value.trim();
      const usuarioAlmacen = document.getElementById('usuarioAlmacen').value.trim();
      const wo             = document.getElementById('wo').value.trim();
      const cliente        = document.getElementById('cliente')?.value || '';
      const out = [];
      for(const f of filasDespacho){
        const danger = (f.disponible <= 0) || (f.qty > 0 && f.qty > f.disponible);
        if(!f.check || !f.qty || danger) continue;
        out.push({
          matricula,
          cliente,
          np: f.material,
          descripcion: f.descripcion,
          wo,
          cantidad: Math.floor(f.qty),
          um: f.bun,
          sloc: f.sloc,
          batch: f.batch,
          neTecnico,
          usuarioAlmacen,
          fecha: new Date().toISOString().replace('T',' ').slice(0,16),
          comentario: f.comentario,
          material: f.material
        });
      }
      if(out.length === 0) return;
      // A√±adir al local para efecto inmediato
      loadLocalDescargas();
      const merged = (DESCARGAS_LOCAL || []).concat(out);
      saveLocalDescargas(merged);
      recomputeDescargas();
      // Intentar push al repo (si hay token)
      const pushed = await pushDescargas();
      if(pushed) await pullDescargas();
      // Limpiar filas marcadas
      filasDespacho = filasDespacho.filter(f => !(f.check && f.qty));
      // Recalcula disponibilidad para las filas restantes antes de re-renderizar
      actualizarDisponibilidad();
      renderDespacho();
      if(!document.getElementById('view-descargas').classList.contains('hidden')) renderDescargas();
      toast(pushed ? 'Sincronizado en repositorio' : 'Despacho guardado (local)');
    }

    // ===== Limpiar filas despacho =====
    function borrarFilas(){ filasDespacho = []; document.getElementById('np').value = ''; renderDespacho(); }

    // ===== Limpiar descargas locales =====
    function limpiarDescargas(){ if(confirm('¬øVaciar la lista local de descargas?')){ localStorage.removeItem(LS_DESC); DESCARGAS_LOCAL = []; recomputeDescargas(); renderDescargas(); } }

    // ===== Exportar descargas a Excel =====
    function exportarDescargas(){
      // Prepara datos en un formato plano (sin claves internas)
      const data = (DESCARGAS || []).map(r => ({
        'Matr√≠cula': r.matricula || '',
        'Cliente': r.cliente || '',
        'NP': r.np || '',
        'Descripci√≥n': r.descripcion || '',
        'WO': r.wo || '',
        'Cantidad': r.cantidad ?? 0,
        'UM': r.um || '',
        'SLoc': r.sloc || '',
        'Batch': r.batch || '',
        'N.E. T√©cnico': r.neTecnico || '',
        'Usuario Almac√©n': r.usuarioAlmacen || '',
        'Fecha': r.fecha || '',
        'Comentario': r.comentario || ''
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'DESCARGAS');
      XLSX.writeFile(wb, 'descargas.xlsx');
    }

    // ===== Exportar descargas a Excel =====
    function exportarDescargas(){
      // Prepara los datos: combina remoto y local para exportar siempre la lista completa
      const rows = (DESCARGAS || []).map(r => ({
        'MATR√çCULA': r.matricula || '',
        'CLIENTE': r.cliente || '',
        'NP': r.np || '',
        'DESCRIPCI√ìN': r.descripcion || '',
        'W.O.': r.wo || '',
        'CANTIDAD': r.cantidad ?? 0,
        'UM': r.um || '',
        'SLOC': r.sloc || '',
        'BATCH': r.batch || '',
        'N.E. T√âCNICO': r.neTecnico || '',
        'USUARIO ALMAC√âN': r.usuarioAlmacen || '',
        'FECHA': r.fecha || '',
        'COMENTARIO': r.comentario || ''
      }));
      // Crea la hoja y libro de trabajo
      const ws = XLSX.utils.json_to_sheet(rows, {
        header: ['MATR√çCULA','CLIENTE','NP','DESCRIPCI√ìN','W.O.','CANTIDAD','UM','SLOC','BATCH','N.E. T√âCNICO','USUARIO ALMAC√âN','FECHA','COMENTARIO']
      });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'DESPACHOS');
      // Genera el archivo Excel para descargar
      XLSX.writeFile(wb, 'descargas.xlsx');
    }

    // ===== Manejo de pesta√±as =====
    const views = { despacho: document.getElementById('view-despacho'), descargas: document.getElementById('view-descargas') };
    document.querySelectorAll('#tabs .tab-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('#tabs .tab-btn').forEach(b => {
          b.classList.remove('bg-sky-600','text-white');
          b.classList.add('bg-white','text-slate-700','border');
        });
        btn.classList.add('bg-sky-600','text-white');
        btn.classList.remove('bg-white','text-slate-700','border');
        Object.keys(views).forEach(k => views[k].classList.toggle('hidden', k !== tab));
        if(tab === 'descargas'){
          await pullDescargas();
          renderDescargas();
        }
      });
    });

    // ===== Listeners principales =====
    document.getElementById('btnBuscar').addEventListener('click', buscar);
    document.getElementById('np').addEventListener('keydown', e => { if(e.key === 'Enter') buscar(); });
    document.getElementById('btnDespachar').addEventListener('click', despachar);
    document.getElementById('btnBorrar').addEventListener('click', borrarFilas);
    document.getElementById('btnLimpiarDescargas').addEventListener('click', limpiarDescargas);

    // Bot√≥n para exportar descargas a Excel
    document.getElementById('btnExportarDescargas').addEventListener('click', exportarDescargas);

    // Exportar descargas a Excel
    document.getElementById('btnExportarDescargas').addEventListener('click', exportarDescargas);

    // ===== Inicializaci√≥n =====
    (async function init(){
      // Aseg√∫rate de cargar la configuraci√≥n antes de empezar (config.js puede definir token)
      if(window.__CONFIG__ === null){
        try{
          const modCfg = await import('./config.js');
          window.__CONFIG__ = modCfg.default || null;
        }catch(e){
          window.__CONFIG__ = null;
        }
      }

      await pullDescargas();
      // Si al cargar se muestra la vista de descargas, re-renderiza
      if(!views.descargas.classList.contains('hidden')) renderDescargas();
      // Actualizaci√≥n peri√≥dica cada 2 segundos: actualiza descargas y, si hay filas, recalcula disponibilidad
      setInterval(async () => {
        await pullDescargas();
        if(!views.descargas.classList.contains('hidden')) renderDescargas();
        // Si hay filas con un NP cargado, recalcula solo la disponibilidad para evitar reiniciar cantidades o selecci√≥n
        const npVal = document.getElementById('np').value.trim();
        if(npVal && filasDespacho.length){
          actualizarDisponibilidad();
          renderDespacho();
        }
      }, 2000);
    })();
  </script>
</body>
</html>
